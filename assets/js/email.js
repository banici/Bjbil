document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("booking-service-overlay"),t=document.getElementById("booking-service-form"),n=document.getElementById("bs-submit"),r=document.getElementById("bs-gdpr"),s=document.getElementById("booking-service-confirm"),l=document.getElementById("bs-confirm-yes"),a=document.getElementById("bs-confirm-no"),i=document.getElementById("bs-gdpr-link"),o=document.getElementById("booking-service-gdpr-info"),c=document.querySelector(".booking-service-gdpr-info-close"),d=document.getElementById("bs-reg");function u(){const e=t.user_name.value.trim(),s=t.user_phone.value.trim(),l=t.user_email.value.trim(),a=t.user_reg.value.trim(),i=t.user_message.value.trim(),o=r.checked,c=Array.from(t.querySelectorAll('input[name="service"]:checked')),d=e&&s&&l&&a,u=i.split(" ").filter(Boolean).length>=2,m=c.length>0,v=d&&o&&(u||m);n.disabled=!v,n.classList.toggle("enabled",v)}d&&d.addEventListener("input",()=>{d.value=d.value.toUpperCase()}),document.querySelectorAll(".dropdown-toggle").forEach(e=>{e.addEventListener("click",()=>{const t=document.getElementById(e.dataset.target).classList.toggle("open");e.classList.toggle("active",t)})}),i.addEventListener("click",e=>{e.preventDefault(),o.style.display="block"}),c.addEventListener("click",()=>{o.style.display="none"}),o.addEventListener("click",e=>{e.target===o&&(o.style.display="none")}),document.querySelectorAll("#bokaLinkSidebar, #bokaLinkNav, .select-btn-1").forEach(n=>{n.addEventListener("click",n=>{n.preventDefault(),e.style.display="block";t.querySelectorAll("#bs-name, #bs-phone, #bs-email, #bs-description, #bs-reg").forEach(e=>e.addEventListener("input",u));t.querySelectorAll('input[name="service"]').forEach(e=>e.addEventListener("change",u)),r.addEventListener("change",u),u()})}),document.querySelector(".booking-service-close").addEventListener("click",()=>{s.style.display="block",e.classList.add("blurred")}),emailjs.init("66lQFUU5otsfLEaYz");t.querySelectorAll("#bs-name, #bs-phone, #bs-email, #bs-description, #bs-reg").forEach(e=>e.addEventListener("input",u));t.querySelectorAll('input[name="service"]').forEach(e=>e.addEventListener("change",u)),r.addEventListener("change",u),t.addEventListener("submit",async s=>{s.preventDefault();const l=Array.from(t.querySelectorAll('input[name="service"]:checked')).map(e=>e.value).join(", "),a=Array.from(t.querySelectorAll('input[name="extra"]:checked')).map(e=>e.value).join(", "),i={user_name:t.user_name.value,user_phone:t.user_phone.value,user_email:t.user_email.value,user_reg:t.user_reg.value,user_message:t.user_message.value,services:l||"Ingen tjänst vald",extra:a||"Inga extra tillägg",gdpr_approved:r.checked?"Ja":"Nej"};n.disabled=!0,n.textContent="Skickar...";try{await emailjs.send("service_nvoy15b","template_4wa6osr",i),alert("✅ Din serviceförfrågan har skickats!"),t.reset(),n.textContent="Skicka",n.disabled=!0,e.style.display="none"}catch(e){console.error(e),alert("❌ Kunde inte skicka formuläret. Försök igen senare."),n.textContent="Skicka",n.disabled=!1}}),e.addEventListener("click",t=>{t.target===e&&(s.style.display="block",e.classList.add("blurred"))}),s.querySelector(".booking-service-confirm-popup").addEventListener("click",e=>{e.stopPropagation()}),a.addEventListener("click",()=>{s.style.display="none",e.classList.remove("blurred")}),l.addEventListener("click",()=>{s.style.display="none",e.style.display="none",t.reset(),n.disabled=!0,n.classList.remove("enabled");t.querySelectorAll(".dropdown-content").forEach(e=>e.classList.remove("open"));t.querySelectorAll(".dropdown-toggle").forEach(e=>e.classList.remove("active")),e.classList.remove("blurred")})});